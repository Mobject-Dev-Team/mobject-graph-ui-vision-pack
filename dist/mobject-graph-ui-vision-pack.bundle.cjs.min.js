/**
 * MIT License
 *
 * Copyright (c) 2024 benhar-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Third Party Licenses
 * --------------------
 *
 * MIT License
 * Copyright (c) 2020 Egor Nepomnyaschih
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("mobject-graph-ui");function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function n(e,t,n){return t=l(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,c()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,g(r.key),r)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,t,n){return(t=g(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(c=function(){return!!e})()}function s(e,t){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},s(e,t)}function f(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,l=[],u=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=a.call(n)).done)&&(l.push(r.value),l.length!==t);u=!0);}catch(e){c=!0,i=e}finally{try{if(!u&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return l}}(e,n)||function(e,n){if(e){if("string"==typeof e)return t(e,n);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?t(e,n):void 0}}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}function y(e,t){if(e===t)return!0;if(null==e||null==t||"object"!==h(e)||"object"!==h(t))return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var i=0,a=n;i<a.length;i++){var o=a[i];if(!r.includes(o)||!y(e[o],t[o]))return!1}return!0}function d(e,t){if(t){var n,r,i=t.imageInfo,a=i.nWidth,o=i.nHeight,l=i.stPixelFormat,u=t.imageData,c=function(e,t,n,r,i){for(var a=r*i/8,o=new Uint8Array(t*n*4),l=0,u=0;u<e.length;u+=a){var c=void 0,s=void 0,f=void 0,g=255;8===i?1===r?c=s=f=e[u]:3===r?(c=e[u],s=e[u+1],f=e[u+2]):4===r&&(c=e[u],s=e[u+1],f=e[u+2],g=e[u+3]):16===i&&(1===r?c=s=f=e[u]+256*e[u+1]>>8:3===r?(c=e[u]+256*e[u+1]>>8,s=e[u+2]+256*e[u+3]>>8,f=e[u+4]+256*e[u+5]>>8):4===r&&(c=e[u]+256*e[u+1]>>8,s=e[u+2]+256*e[u+3]>>8,f=e[u+4]+256*e[u+5]>>8,g=e[u+6]+256*e[u+7]>>8)),o.set([c,s,f,g],l),l+=4}return o}((n=u,r=window.atob(n),new Uint8Array(r.split("").map((function(e){return e.charCodeAt(0)})))),a,o,l.nChannels,l.nElementSize);!function(e,t,n,r){var i=document.createElement("canvas");i.width=n,i.height=r;var a=i.getContext("2d"),o=new ImageData(new Uint8ClampedArray(t),n,r);a.putImageData(o,0,0),e.src=i.toDataURL("image/png")}(e,c,a,o)}}var p=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];function v(e){var t,n="",r=e.length;for(t=2;t<r;t+=3)n+=p[e[t-2]>>2],n+=p[(3&e[t-2])<<4|e[t-1]>>4],n+=p[(15&e[t-1])<<2|e[t]>>6],n+=p[63&e[t]];return t===r+1&&(n+=p[e[t-2]>>2],n+=p[(3&e[t-2])<<4],n+="=="),t===r&&(n+=p[e[t-2]>>2],n+=p[(3&e[t-2])<<4|e[t-1]>>4],n+=p[(15&e[t-1])<<2],n+="="),n}var m=function(){function t(e,i,a){var o;return r(this,t),(o=n(this,t,[e,i,a])).image=new Image,o.previousValue=null,o}return u(t,e.DisplayWidget),a(t,[{key:"onContentUpdate",value:function(e){y(e,this.previousValue)||(d(this.image,e),this.previousValue=e)}},{key:"computeSize",value:function(){return new Float32Array([60,60])}},{key:"draw",value:function(e,t,n,r,i){this.margin=5;var a=n-2*this.margin+1,o=t.size[1]-this.margin-r;e.fillStyle="#303030",e.fillRect(this.margin,r,a,o),e.beginPath(),e.rect(this.margin,r,a,o),e.clip();var l=o/10,u=a/10;e.beginPath();for(var c=0;c<l;++c)for(var s=0,f=u/2;s<f;++s)e.rect(2*s*10+(c%2?0:10)+this.margin,10*c+r,10,10);if(e.fillStyle="#303030",e.fill(),e.strokeStyle=this.outline_color,e.strokeRect(this.margin,r,a,o),!this.image)return e.textAlign="center",e.fillStyle=this.secondary_text_color,e.font="italic 10pt Sans-serif",void e.fillText("No image",.5*n,r+.5*o);e.drawImage(this.image,this.margin,r,a,o)}}])}(),b=function(){function t(e,i,a,o){var l;return r(this,t),(l=n(this,t,[e,i,a,o]))._url=null,l._img=null,l._size=t.DEFAULT_SIZE,l._offscreenCanvas=null,l.setDefaultValue(l.getDefaultImageData()),l}return u(t,e.ControlWidget),a(t,[{key:"onDisplayValueChanged",value:function(e,t){console.log(e)}},{key:"computeSize",value:function(e){return this._size}},{key:"mouse",value:function(e,t,n){}},{key:"draw",value:function(e,t,n,r,i){var a=n-10,o=t.size[1]-5-r;this.drawBackground(e,5,r,a,o),this.drawOutline(e,5,r,a,o),this.drawImageOrPlaceholder(e,5,n,r,a,o)}},{key:"onDropFile",value:function(e){return this.isSupportedFileType(e)?(this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(e),this.loadImage(this._url),!0):(console.error("Unsupported file type:",e.type),!1)}},{key:"isSupportedFileType",value:function(e){return t.SUPPORTED_TYPES.includes(e.type)}},{key:"loadImage",value:function(e){var t=new Image;t.src=e,t.onload=this.handleImageLoad.bind(this,t),t.onerror=function(){return console.error("Error loading the image: ".concat(e))}}},{key:"handleImageLoad",value:function(e){var t=f(this.calculateNewDimensions(e),2),n=t[0],r=t[1];this._size=new Float32Array([n,r]),this.setupOffscreenCanvas(e),this.setValue(this.serializeOffscreenCanvas()),this.triggerParentResetSize()}},{key:"calculateNewDimensions",value:function(e){return[300*(e.width/e.height),300]}},{key:"setupOffscreenCanvas",value:function(e){this._offscreenCanvas=new OffscreenCanvas(e.width,e.height),this._offscreenCanvas.getContext("2d").drawImage(e,0,0,e.width,e.height)}},{key:"serializeOffscreenCanvas",value:function(){var e=this._offscreenCanvas.getContext("2d").getImageData(0,0,this._offscreenCanvas.width,this._offscreenCanvas.height);return{imageInfo:{nImageSize:e.data.length,nWidth:this._offscreenCanvas.width,nHeight:this._offscreenCanvas.height,nXPadding:0,nYPadding:0,stPixelFormat:{bSupported:!0,bSigned:!1,bPlanar:!1,bFloat:!1,nChannels:4,ePixelEncoding:"TCVN_PE_NONE",ePixelPackMode:"TCVN_PPM_NONE",nElementSize:8,nTotalSize:24}},imageData:v(e.data)}}},{key:"drawBackground",value:function(e,n,r,i,a){e.fillStyle=t.BACKGROUND_COLOR,e.fillRect(n,r,i,a)}},{key:"drawOutline",value:function(e,n,r,i,a){e.strokeStyle=t.OUTLINE_COLOR,e.strokeRect(n,r,i,a)}},{key:"drawImageOrPlaceholder",value:function(e,n,r,i,a,o){this._offscreenCanvas?e.drawImage(this._offscreenCanvas,n,i,a,o):(e.textAlign="center",e.fillStyle=t.TEXT_COLOR,e.font="italic 10pt Sans-serif",e.fillText("Drag image here...",.5*r,i+.5*o))}},{key:"getDefaultImageData",value:function(){return{imageInfo:{nImageSize:0,nWidth:0,nHeight:0,nXPadding:0,nYPadding:0,stPixelFormat:{bSupported:!0,bSigned:!1,bPlanar:!1,bFloat:!1,nChannels:4,ePixelEncoding:"TCVN_PE_NONE",ePixelPackMode:"TCVN_PPM_NONE",nElementSize:0,nTotalSize:0}},imageData:""}}}])}();o(b,"SUPPORTED_TYPES",["image/jpeg","image/png","image/bmp"]),o(b,"DEFAULT_SIZE",new Float32Array([100,100])),o(b,"OUTLINE_COLOR","#000"),o(b,"BACKGROUND_COLOR","#303030"),o(b,"TEXT_COLOR","#FFF");var O=function(){return a((function e(){r(this,e)}),null,[{key:"install",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e.GraphFramework;this.registerWidgets(t),this.registerFileAssociation(t)}},{key:"registerWidgets",value:function(e){e.registerWidgetType(b,"INTERFACE","ITcVnImage"),e.registerWidgetType(m,"INTERFACE","ITcVnImage")}},{key:"registerFileAssociation",value:function(e){e.registerFileAssociation(["jpg","png","bmp"],"Literal/ITcVnImage","value")}}])}();exports.VisionPack=O;
