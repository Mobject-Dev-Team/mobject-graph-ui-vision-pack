/**
 * MIT License
 *
 * Copyright (c) 2024 benhar-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Third Party Licenses
 * --------------------
 *
 * MIT License
 * Copyright (c) 2020 Egor Nepomnyaschih
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

import{DisplayWidget as e,ControlWidget as t,GraphFramework as i}from"mobject-graph-ui";const a=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];function n(e){let t,i="",n=e.length;for(t=2;t<n;t+=3)i+=a[e[t-2]>>2],i+=a[(3&e[t-2])<<4|e[t-1]>>4],i+=a[(15&e[t-1])<<2|e[t]>>6],i+=a[63&e[t]];return t===n+1&&(i+=a[e[t-2]>>2],i+=a[(3&e[t-2])<<4],i+="=="),t===n&&(i+=a[e[t-2]>>2],i+=a[(3&e[t-2])<<4|e[t-1]>>4],i+=a[(15&e[t-1])<<2],i+="="),i}function r(e,t){if(!e)return;const{imageInfo:{nWidth:i,nHeight:a,stPixelFormat:n},imageData:r}=e,s=function(e){const t=window.atob(e);return new Uint8Array(t.split("").map((e=>e.charCodeAt(0))))}(r),{nChannels:o,nElementSize:g}=n,l=function(e,t,i,a,n){const r=a*n/8,s=new Uint8Array(t*i*4);let o=0;for(let t=0;t<e.length;t+=r){let i,r,g,l=255;8===n?1===a?i=r=g=e[t]:3===a?(i=e[t],r=e[t+1],g=e[t+2]):4===a&&(i=e[t],r=e[t+1],g=e[t+2],l=e[t+3]):16===n&&(1===a?i=r=g=e[t]+256*e[t+1]>>8:3===a?(i=e[t]+256*e[t+1]>>8,r=e[t+2]+256*e[t+3]>>8,g=e[t+4]+256*e[t+5]>>8):4===a&&(i=e[t]+256*e[t+1]>>8,r=e[t+2]+256*e[t+3]>>8,g=e[t+4]+256*e[t+5]>>8,l=e[t+6]+256*e[t+7]>>8)),s.set([i,r,g,l],o),o+=4}return s}(s,i,a,o,g);!function(e,t,i,a){const n=function(e,t){const i=document.createElement("canvas");return i.width=e,i.height=t,i}(i,a),r=n.getContext("2d"),s=new ImageData(new Uint8ClampedArray(t),i,a);r.putImageData(s,0,0),e.src=n.toDataURL("image/png")}(t,l,i,a)}class s extends e{constructor(e,t,i){super(e,t,i),this.image=new Image,this.on("valueChanged",((e,t)=>{e?r(e,this.image):this.image=new Image}))}computeSize(){return new Float32Array([60,60])}draw(e,t,i,a,n){const r=i-10+1,s=t.size[1]-5-a;e.fillStyle="#303030",e.fillRect(5,a,r,s),e.beginPath(),e.rect(5,a,r,s),e.clip();let o=s/10,g=r/10;e.beginPath();for(var l=0;l<o;++l)for(var c=0,d=g/2;c<d;++c)e.rect(2*c*10+(l%2?0:10)+5,10*l+a,10,10);if(e.fillStyle="#303030",e.fill(),e.strokeStyle=this.outline_color,e.strokeRect(5,a,r,s),""==this.image.src)return e.textAlign="center",e.fillStyle="#FFFFFF",e.font="italic 10pt Sans-serif",void e.fillText("No image",.5*i,a+.5*s);e.drawImage(this.image,5,a,r,s)}}class o extends t{static SUPPORTED_TYPES=["image/jpeg","image/png","image/bmp"];static DEFAULT_SIZE=new Float32Array([100,100]);static OUTLINE_COLOR="#000";static BACKGROUND_COLOR="#303030";static TEXT_COLOR="#FFF";constructor(e,t,i,a){super(e,t,i,a),this.image=new Image,this._size=o.DEFAULT_SIZE,this.value=this.getDefaultImageData(),this.on("valueChanged",((e,t)=>{r(e,this.image)}))}computeSize(e){return this._size}mouse(e,t,i){}draw(e,t,i,a,n){const r=i-10,s=t.size[1]-5-a;if(this.drawBackground(e,5,a,r,s),this.drawOutline(e,5,a,r,s),""==this.image.src)return e.textAlign="center",e.fillStyle="#FFFFFF",e.font="italic 10pt Sans-serif",void e.fillText("Drag image here",.5*i,a+.5*s);e.drawImage(this.image,5,a,r,s)}onDropFile(e){if(!this.isSupportedFileType(e))return console.error("Unsupported file type:",e.type),!1;const t=URL.createObjectURL(e);return this.loadDroppedImageToWidget(t),!0}isSupportedFileType(e){return o.SUPPORTED_TYPES.includes(e.type)}loadDroppedImageToWidget(e){const t=new Image;t.src=e,t.onload=this.handleImageOnLoad.bind(this,t),t.onerror=()=>{console.error(`Error loading the image: ${e}`),URL.revokeObjectURL(e)}}handleImageOnLoad(e){this.setWidgetSizeToImage(e),this.value=function(e){const t=new OffscreenCanvas(e.width,e.height),i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const a=i.getImageData(0,0,t.width,t.height);return{imageInfo:{nImageSize:a.data.length,nWidth:t.width,nHeight:t.height,nXPadding:0,nYPadding:0,stPixelFormat:{bSupported:!0,bSigned:!1,bPlanar:!1,bFloat:!1,nChannels:4,ePixelEncoding:"TCVN_PE_NONE",ePixelPackMode:"TCVN_PPM_NONE",nElementSize:8,nTotalSize:24}},imageData:n(a.data)}}(e),URL.revokeObjectURL(e.src)}setWidgetSizeToImage(e){let t=300*(e.width/e.height);this._size=new Float32Array([t,300]),this.triggerParentResetSize()}drawBackground(e,t,i,a,n){e.fillStyle=o.BACKGROUND_COLOR,e.fillRect(t,i,a,n)}drawOutline(e,t,i,a,n){e.strokeStyle=o.OUTLINE_COLOR,e.strokeRect(t,i,a,n)}getDefaultImageData(){return{imageInfo:{nImageSize:0,nWidth:0,nHeight:0,nXPadding:0,nYPadding:0,stPixelFormat:{bSupported:!0,bSigned:!1,bPlanar:!1,bFloat:!1,nChannels:4,ePixelEncoding:"TCVN_PE_NONE",ePixelPackMode:"TCVN_PPM_NONE",nElementSize:0,nTotalSize:0}},imageData:""}}}class g{install(e=new i,t){this.registerWidgets(e,t),this.registerFileAssociation(e,t)}registerWidgets(e,t={}){e.registerWidgetType(o,"INTERFACE","ITcVnImage"),e.registerWidgetType(s,"INTERFACE","ITcVnImage")}registerFileAssociation(e,t={}){e.registerFileAssociation(["jpg","png","bmp"],"Literal/ITcVnImage","value")}}export{g as VisionPack};
